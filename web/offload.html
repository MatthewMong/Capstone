<button onclick="onButtonClick()">transfer</button>
<button onclick="onSave()">save</button>
<button onclick="onDisconnect()">disconnect</button>
<div>
  <p style="word-break: break-word">
    Data:<br />
    <span id="myText"></span><br />
    Device: <br />
    <span id="deviceText"></span><br />
  </p>
</div>
<script>
  let data = new Array(90000);
  let spot = 0;
  var bluetoothDevice;
  function onButtonClick() {
    let serviceUuid = "0000181a-0000-1000-8000-00805f9b34fb";
    let characteristicUuid = "00002a59-0000-1000-8000-00805f9b34fb";
    console.log("Requesting Bluetooth Device...");
    navigator.bluetooth
      .requestDevice({ filters: [{ services: [serviceUuid] }] })
      .then((device) => {
        console.log("Connecting to GATT Server...");
        bluetoothDevice = device;
        document.getElementById("deviceText").innerHTML = device;
        return device.gatt.connect();
      })
      .then((server) => {
        console.log("Getting Service...");
        return server.getPrimaryService(serviceUuid);
      })
      .then((service) => {
        console.log("Getting Characteristic...");
        return service.getCharacteristics(characteristicUuid);
      })
      .then((characteristics) => {
        char = characteristics[0];
        return char.startNotifications().then((_) => {
          console.log("> Notifications started");
          document.getElementById("myText").innerHTML = "downloading";
          char.addEventListener(
            "characteristicvaluechanged",
            handleNotifications
          );
        });
      })
      .catch((error) => {
        console.log("Argh! " + error);
      });
  }

  function handleNotifications(event) {
    let value = event.target.value;
    data[spot] = value;
    if (spot % 10 == 0) {
      document.getElementById("myText").innerHTML = spot;
    }
    spot++;
  }

  function onDisconnect() {
    if (bluetoothDevice) {
      bluetoothDevice.gatt.disconnect();
    }
    document.getElementById("deviceText").innerHTML = device || "none";
  }

  function onSave() {
    var enc = new TextDecoder();
    const parsedData = data
      .filter(function (element) {
        return element !== undefined;
      })
      .map((value) => enc.decode(value));
    let lines = [];
    for (let i = 0; i < parsedData.length; i += 1) {
      chunk = parsedData[i].toString();
      lines.push(i == 0 ? "data:text/csv;charset=utf-8," + chunk : chunk);
    }
    var csvContent = lines.join("");
    var encodedUri = encodeURI(csvContent);
    window.open(encodedUri);
  }
</script>
